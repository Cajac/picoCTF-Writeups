# RPS

- [Challenge information](#challenge-information)
- [Solution](#solution)
- [References](#references)

## Challenge information
```
Points: 200
Tags: picoCTF 2022, Binary Exploitation
Author: WILL HONG

Description:
Here's a program that plays rock, paper, scissors against you. 
I hear something good happens if you win 5 times in a row.

Connect to the program with netcat:
$ nc saturn.picoctf.net 62039

The program's source code with the flag redacted can be downloaded here.
 
Hints:
1. How does the program check if you won?
```

## Solution

### Study the source code

Lets start by studying the C source code.  
The `main` function of the program look like this (including the global declarations and excluding some empty lines)
```c
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <time.h>
#include <unistd.h>
#include <sys/time.h>
#include <sys/types.h>

#define WAIT 60

static const char* flag = "[REDACTED]";

char* hands[3] = {"rock", "paper", "scissors"};
char* loses[3] = {"paper", "scissors", "rock"};
int wins = 0;

<---Other functions removed--->

int main () {
  char input[3] = {'\0'};
  int command;
  int r;

  puts("Welcome challenger to the game of Rock, Paper, Scissors");
  puts("For anyone that beats me 5 times in a row, I will offer up a flag I found");
  puts("Are you ready?");
  
  while (true) {
    puts("Type '1' to play a game");
    puts("Type '2' to exit the program");
    r = tgetinput(input, 3);
    // Timeout on user input
    if(r == -3)
    {
      printf("Goodbye!\n");
      exit(0);
    }
    
    if ((command = strtol(input, NULL, 10)) == 0) {
      puts("Please put in a valid number");
      
    } else if (command == 1) {
      printf("\n\n");
      if (play()) {
        wins++;
      } else {
        wins = 0;
      }

      if (wins >= 5) {
        puts("Congrats, here's the flag!");
        puts(flag);
      }
    } else if (command == 2) {
      return 0;
    } else {
      puts("Please type either 1 or 2");
    }
  }

  return 0;
}
```
Nothing much interesting here except that if we win 5 times we get the flag.
```c
      if (wins >= 5) {
        puts("Congrats, here's the flag!");
        put
```

The `play` function looks like this
```c
bool play () {
  char player_turn[100];
  srand(time(0));
  int r;

  printf("Please make your selection (rock/paper/scissors):\n");
  r = tgetinput(player_turn, 100);
  // Timeout on user input
  if(r == -3)
  {
    printf("Goodbye!\n");
    exit(0);
  }

  int computer_turn = rand() % 3;
  printf("You played: %s\n", player_turn);
  printf("The computer played: %s\n", hands[computer_turn]);

  if (strstr(player_turn, loses[computer_turn])) {
    puts("You win! Play again?");
    return true;
  } else {
    puts("Seems like you didn't win this time. Play again?");
    return false;
  }
}
```
At the beginning of the function we see that the [seed](https://en.wikipedia.org/wiki/Random_seed) is initialized with the current time, `srand(time(0));`.  
Later on the program chooses a move with `int computer_turn = rand() % 3;`.

That is not so random and we can easily setup a program that predicts the [pseudorandom](https://en.wikipedia.org/wiki/Pseudorandom_number_generator) choices since we know the current time.

### Do a test run

Before we put together a script that predicts the choices, lets do a test run of the server
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2022/Binary_Exploitation/RPS]
└─$ nc saturn.picoctf.net 62039
Welcome challenger to the game of Rock, Paper, Scissors
For anyone that beats me 5 times in a row, I will offer up a flag I found
Are you ready?
Type '1' to play a game
Type '2' to exit the program
1
1


Please make your selection (rock/paper/scissors):
paper
paper
You played: paper
The computer played: rock
You win! Play again?
Type '1' to play a game
Type '2' to exit the program
1
1


Please make your selection (rock/paper/scissors):
rock
rock
You played: rock
The computer played: paper
Seems like you didn't win this time. Play again?
Type '1' to play a game
Type '2' to exit the program
2
2
```

### Create an exploit script

Now lets write an exploit in Python with the help of [pwntools](https://docs.pwntools.com/en/stable/index.html) and [ctypes](https://docs.python.org/3/library/ctypes.html)
```python
from pwn import *
from time import time
from ctypes import CDLL

SERVER = 'saturn.picoctf.net'
PORT = 62039

# Set output level (critical, error, warning, info (default), debug)
context.log_level = "info"

io = remote(SERVER, PORT)
libc = CDLL('/lib/x86_64-linux-gnu/libc.so.6')

hands = ["rock", "paper", "scissors"]
    
for i in range(5):
    log.info(f"Game turn #{i+1}")
    io.recvuntil(b'program')
    io.sendline(b'1')
    
    # Predict computer's choice
    libc.srand(int(time()))
    computer_turn = libc.rand() % 3   
    
    # Calculate winning move
    if hands[computer_turn] == "rock":
        payload = b'paper'
    elif hands[computer_turn] == "paper":
        payload = b'scissors'
    elif hands[computer_turn] == "scissors":
        payload = b'rock'
        
    # Submit our winning move
    io.recvuntil(b':')
    io.sendline(payload)
    
# Get the flag
junk = io.recvuntil(b'flag!\r\n')
flag = io.recvuntilS(b'}\r\n')
log.warn(flag)
io.close()
```

### Connect to the server and get the flag

Finally, lets exploit and get the flag
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2022/Binary_Exploitation/RPS]
└─$ ~/python_venvs/pwntools/bin/python rps_exploit.py
[+] Opening connection to saturn.picoctf.net on port 62039: Done
[*] Game turn #1
[*] Game turn #2
[*] Game turn #3
[*] Game turn #4
[*] Game turn #5
[!] picoCTF{<REDACTED>}
[*] Closed connection to saturn.picoctf.net port 62039
```

For additional information, please see the references below.

## References

- [ctypes - Python](https://docs.python.org/3/library/ctypes.html)
- [pwntools - Documentation](https://docs.pwntools.com/en/stable/index.html)
- [srand - Linux manual page](https://man7.org/linux/man-pages/man3/rand_r.3.html)
- [time - Linux manual page](https://www.man7.org/linux/man-pages/man2/time.2.html)
- [Wikipedia - Pseudorandom number generator](https://en.wikipedia.org/wiki/Pseudorandom_number_generator)
- [Wikipedia - Random seed](https://en.wikipedia.org/wiki/Random_seed)
